{% extends "admin/change_form.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<style>
    /* Tus estilos existentes se mantienen igual */
    .drop-zone {
        border: 2px dashed #007bff;
        border-radius: 5px;
        padding: 20px;
        text-align: center;
        margin: 20px 0;
        background-color: #f8f9fa;
    }
    .drop-zone.dragover {
        background-color: #e9ecef;
        border-color: #0056b3;
    }
    .file-list {
        margin-top: 10px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
        padding: 10px;
    }
    .file-item {
        padding: 10px;
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 3px;
        position: relative;
    }
    .file-item img {
        max-width: 100%;
        height: auto;
        margin-bottom: 5px;
    }
    .file-item .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: red;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
    .hidden-inputs {
        display: none;
    }
    .error-message {
        color: red;
        margin-top: 5px;
        font-size: 0.9em;
    }
    .image-counter {
        margin-top: 10px;
        font-size: 0.9em;
        color: #666;
    }
    .drop-zone.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block after_field_sets %}
{{ block.super }}
<div class="drop-zone" id="dropZone">
    <h2>Arrastra y suelta las imágenes de la propiedad aquí</h2>
    <p>o haz clic para seleccionar imágenes</p>
    <p class="image-counter">Imágenes: <span id="imageCount">0</span>/30</p>
    <p class="error-message" id="errorMessage" style="display: none;"></p>
    <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
    <div class="file-list" id="fileList"></div>
</div>
<div class="hidden-inputs" id="hiddenInputs">
    {% for i in "123456789012345678901234567890"|make_list %}
    <input type="hidden" name="img{{ forloop.counter }}" id="img{{ forloop.counter }}" value="{% if original %}{{ original.img1|default:'' }}{% endif %}">
    {% endfor %}
    <input type="hidden" name="mapImg" id="mapImg" value="{% if original %}{{ original.mapImg|default:'' }}{% endif %}">
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const hiddenInputs = document.getElementById('hiddenInputs');
    const errorMessage = document.getElementById('errorMessage');
    const imageCount = document.getElementById('imageCount');
    let uploadedFiles = {};
    const MAX_IMAGES = 30;

    // Cargar imágenes existentes
    function loadExistingImages() {
        let count = 0;
        for (let i = 1; i <= MAX_IMAGES; i++) {
            const fieldName = `img${i}`;
            const input = document.getElementById(fieldName);
            if (input && input.value) {
                const fileName = input.value.split('/').pop();
                uploadedFiles[fieldName] = fileName;
                addImageToGrid(fileName, fieldName, true);
                count++;
            }
        }
        updateImageCount();
        updateDropZoneState();
    }

    function updateImageCount() {
        const count = Object.keys(uploadedFiles).length;
        imageCount.textContent = count;
        updateDropZoneState();
    }

    function updateDropZoneState() {
        const count = Object.keys(uploadedFiles).length;
        dropZone.classList.toggle('disabled', count >= MAX_IMAGES);
    }

    // Eventos de drag and drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    dropZone.addEventListener('drop', handleDrop, false);
    
    // Manejo de clic y selección de archivos
    dropZone.addEventListener('click', () => {
        if (Object.keys(uploadedFiles).length < MAX_IMAGES) {
            fileInput.click();
        } else {
            showError('Has alcanzado el límite de 30 imágenes');
        }
    });
    fileInput.addEventListener('change', handleFiles);

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function highlight(e) {
        if (Object.keys(uploadedFiles).length < MAX_IMAGES) {
            dropZone.classList.add('dragover');
        }
    }

    function unhighlight(e) {
        dropZone.classList.remove('dragover');
    }

    function handleDrop(e) {
        if (Object.keys(uploadedFiles).length >= MAX_IMAGES) return;
        const dt = e.dataTransfer;
        handleFiles({ target: { files: dt.files } });
    }

    function handleFiles(e) {
        const files = Array.from(e.target.files);
        const remainingSlots = MAX_IMAGES - Object.keys(uploadedFiles).length;
        
        if (files.length > remainingSlots) {
            showError(`Solo puedes subir ${remainingSlots} imagen(es) más`);
            files.splice(remainingSlots);
        }

        files.forEach(file => {
            if (!file.type.startsWith('image/')) {
                showError('Solo se permiten archivos de imagen');
                return;
            }
            uploadFile(file);
        });
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        setTimeout(() => {
            errorMessage.style.display = 'none';
        }, 3000);
    }

    function addImageToGrid(fileName, fieldName, isExisting = false) {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.dataset.field = fieldName;
        
        const img = document.createElement('img');
        img.src = isExisting ? `/static/media/${fileName}` : URL.createObjectURL(file);
        fileItem.appendChild(img);

        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.innerHTML = '×';
        removeBtn.onclick = () => removeFile(fileItem, fieldName);
        fileItem.appendChild(removeBtn);

        const fileNameDiv = document.createElement('div');
        fileNameDiv.textContent = fileName;
        fileItem.appendChild(fileNameDiv);

        fileList.appendChild(fileItem);
    }

    function uploadFile(file) {
        const fieldName = getNextAvailableField();
        if (!fieldName) {
            showError('No hay más campos disponibles para imágenes');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('field_name', fieldName);
        formData.append('prop_id', '{{ original.id }}');

        const fileItem = createFileItem(file, fieldName);
        
        fetch('/admin/api/upload/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                uploadedFiles[fieldName] = data.file_path;
                document.getElementById(fieldName).value = data.file_path;
                updateImageCount();
                fileItem.style.borderColor = 'green';
            } else {
                fileItem.remove();
                showError(data.error || 'Error al subir la imagen');
            }
        })
        .catch(error => {
            fileItem.remove();
            showError('Error al subir la imagen');
            console.error('Error:', error);
        });
    }

    function createFileItem(file, fieldName) {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.dataset.field = fieldName;
        
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        fileItem.appendChild(img);

        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.innerHTML = '×';
        removeBtn.onclick = () => removeFile(fileItem, fieldName);
        fileItem.appendChild(removeBtn);

        const fileNameDiv = document.createElement('div');
        fileNameDiv.textContent = file.name;
        fileItem.appendChild(fileNameDiv);

        fileList.appendChild(fileItem);
        return fileItem;
    }

    function removeFile(fileItem, fieldName) {
        document.getElementById(fieldName).value = '';
        delete uploadedFiles[fieldName];
        fileItem.remove();
        updateImageCount();
    }

    function getNextAvailableField() {
        for (let i = 1; i <= MAX_IMAGES; i++) {
            const fieldName = `img${i}`;
            if (!uploadedFiles[fieldName]) return fieldName;
        }
        return null;
    }

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // Inicializar
    loadExistingImages();
});
</script>
{% endblock %}